<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Interest Calculator Pro</title>
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“ˆ</text></svg>"
    />

    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      * {
        box-sizing: border-box;
        font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      }
      :root {
        --bg: #f8fafc;
        --card: #ffffff;
        --text: #1e293b;
        --accent: #4f46e5;
        --secondary: #64748b;
        --border: #e2e8f0;
      }
      body {
        margin: 0;
        background: var(--bg);
        color: var(--text);
        transition: background 0.3s;
        line-height: 1.5;
        overflow-x: hidden;
      }
      body.dark {
        --bg: #0f172a;
        --card: #1e293b;
        --text: #f1f5f9;
        --accent: #818cf8;
        --border: #334155;
      }

      .app {
        width: 100%;
        max-width: 900px;
        margin: auto;
        padding: 12px;
      }

      /* --- HEADER --- */
      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--border);
      }
      h1 {
        font-size: 1.25rem;
        margin: 0;
      }
      .theme-toggle {
        background: var(--card);
        color: var(--text);
        border: 1px solid var(--border);
        padding: 6px 12px;
        border-radius: 20px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.75rem;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      /* ANIMATION RESTORED HERE */
      #theme-icon {
        transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        display: inline-block;
      }
      .rotate-icon {
        transform: rotate(360deg) scale(1.2);
      }

      /* --- CARDS & GRID --- */
      .card {
        background: var(--card);
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        margin-bottom: 16px;
        border: 1px solid var(--border);
      }
      .section-header {
        margin-bottom: 16px;
        padding-bottom: 6px;
        border-bottom: 2px solid var(--bg);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .section-title {
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--accent);
        font-weight: 800;
      }

      .grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 16px;
      }
      @media (min-width: 600px) {
        .app {
          padding: 20px;
        }
        .card {
          padding: 24px;
        }
        .grid-2 {
          grid-template-columns: 1fr 1fr;
        }
        h1 {
          font-size: 1.5rem;
        }
        .chart-grid {
          display: grid;
          grid-template-columns: 2fr 1fr;
          gap: 20px;
        }
      }

      /* --- INPUTS & SLIDERS --- */
      label {
        font-weight: 600;
        font-size: 0.8rem;
        display: block;
        margin-bottom: 4px;
        color: var(--secondary);
      }
      .required::after {
        content: " *";
        color: #ef4444;
        font-weight: bold;
      }

      input,
      select {
        width: 100%;
        padding: 12px;
        border-radius: 8px;
        border: 1px solid var(--border);
        font-size: 1rem;
        background: var(--card);
        color: var(--text);
        outline: none;
        transition: all 0.2s;
      }
      input:focus,
      select:focus {
        border-color: var(--accent);
      }

      /* Range Slider Styling */
      input[type="range"] {
        -webkit-appearance: none;
        width: 100%;
        height: 6px;
        background: var(--border);
        border-radius: 5px;
        outline: none;
        margin-top: 10px;
        padding: 0;
        border: none;
      }
      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: var(--accent);
        cursor: pointer;
      }

      /* --- BUTTONS --- */
      .row-presets {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
        margin-top: 10px;
      }
      .row-presets button {
        background: var(--bg);
        color: var(--secondary);
        font-size: 0.75rem;
        font-weight: 700;
        border: 1px solid var(--border);
        padding: 10px;
        border-radius: 8px;
        cursor: pointer;
      }
      .row-presets button.active {
        background: var(--accent);
        color: white;
        border-color: var(--accent);
      }

      .calculate-btn {
        width: 100%;
        background: var(--accent);
        color: #fff;
        border: none;
        font-weight: 700;
        font-size: 1rem;
        cursor: pointer;
        padding: 16px;
        border-radius: 12px;
        margin-top: 16px;
        box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.4);
        transition: all 0.3s ease;
      }
      .calculate-btn:disabled {
        background-color: #cbd5e1;
        box-shadow: none;
        cursor: not-allowed;
        opacity: 0.6;
      }

      /* --- HISTORY SECTION --- */
      .history-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        border-bottom: 1px solid var(--border);
        cursor: pointer;
        transition: background 0.2s;
      }
      .history-item:hover {
        background: var(--bg);
      }
      .history-item:last-child {
        border-bottom: none;
      }
      .history-details {
        font-size: 0.8rem;
        color: var(--secondary);
      }
      .history-amount {
        font-weight: 700;
        color: var(--accent);
      }

      /* --- RESULTS --- */
      .summary-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 12px;
      }
      @media (min-width: 480px) {
        .summary-grid {
          grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        }
      }
      .result-box {
        background: var(--bg);
        border-radius: 12px;
        padding: 16px;
        text-align: center;
        border: 1px solid var(--border);
      }
      .result-box.highlight {
        background: var(--accent);
        color: white;
        border: none;
      }
      .result-box span {
        font-size: 0.7rem;
        text-transform: uppercase;
        font-weight: 700;
        opacity: 0.8;
      }
      .value {
        font-size: 1.25rem;
        font-weight: 800;
        margin-top: 4px;
      }

      .table-container {
        width: 100%;
        overflow-x: auto;
        margin-top: 15px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        min-width: 450px;
      }
      th,
      td {
        padding: 10px;
        border-bottom: 1px solid var(--border);
        text-align: right;
        font-size: 0.85rem;
      }
      th {
        background: var(--bg);
        font-size: 0.7rem;
        color: var(--secondary);
        text-transform: uppercase;
      }
      canvas {
        max-width: 100%;
      }
    </style>
  </head>

  <body>
    <div class="app">
      <header>
        <h1>ðŸ“ˆ Interest Pro</h1>
        <button class="theme-toggle" onclick="toggleTheme()">
          <span id="theme-icon">ðŸŒ™</span> <span id="theme-text"></span>
        </button>
      </header>

      <div class="card">
        <div class="section-header">
          <span class="section-title">1. Duration</span>
        </div>
        <div class="grid grid-2">
          <div>
            <label class="required">Start Date</label
            ><input type="date" id="startDate" />
          </div>
          <div>
            <label class="required">End Date</label
            ><input type="date" id="endDate" />
          </div>
        </div>
        <div class="row-presets" id="yearPresets">
          <button onclick="setYears(1, this)">1Y</button>
          <button onclick="setYears(3, this)">3Y</button>
          <button onclick="setYears(5, this)">5Y</button>
          <button onclick="setYears(10, this)">10Y</button>
        </div>
        <div style="margin-top: 15px">
          <label>Or Enter Months</label>
          <input type="number" id="monthsInput" placeholder="e.g. 15" />
        </div>
      </div>

      <div class="card">
        <div class="section-header">
          <span class="section-title">2. Financials</span>
        </div>
        <div class="grid">
          <div>
            <label class="required">Principal Amount (â‚¹)</label>
            <input
              type="text"
              id="principal"
              placeholder="0.00"
              onblur="formatInput(this)"
              onfocus="unformatInput(this)"
            />
            <input
              type="range"
              id="principalRange"
              min="1000"
              max="10000000"
              step="1000"
              value="0"
            />
          </div>

          <div class="grid grid-2">
            <div style="display: flex; flex-direction: column; gap: 10px">
              <div>
                <label class="required">Logic</label>
                <select id="logicType" onchange="toggleCompoundFreq()">
                  <option value="simple">Simple Interest</option>
                  <option value="compound">Compound Interest</option>
                </select>
              </div>
              <div id="freqContainer" style="display: none">
                <label>Frequency</label>
                <select id="compoundFreq">
                  <option value="12">Yearly</option>
                  <option value="6">Half-Yearly</option>
                  <option value="3">Quarterly</option>
                  <option value="1">Monthly</option>
                </select>
              </div>
            </div>

            <div>
              <label class="required">Interest Rate</label>
              <div style="display: flex; gap: 5px">
                <input
                  type="number"
                  id="rate"
                  step="0.01"
                  placeholder="e.g. 2.0"
                  style="flex: 1"
                />
                <select id="interestType" style="flex: 1">
                  <option value="flat">â‚¹ / mo</option>
                  <option value="per100">â‚¹ / 100 / mo</option>
                  <option value="percent">% / mo</option>
                </select>
              </div>
              <input
                type="range"
                id="rateRange"
                min="0.1"
                max="10"
                step="0.1"
                value="2"
              />
            </div>
          </div>
        </div>
        <button
          id="calcBtn"
          class="calculate-btn"
          onclick="calculate()"
          disabled
        >
          CALCULATE
        </button>
      </div>

      <div id="outputWrapper">
        <div id="output"></div>
      </div>

      <div class="card" id="historyCard" style="display: none">
        <div class="section-header">
          <span class="section-title">ðŸ•’ Recent History</span>
        </div>
        <div id="historyList"></div>
        <div style="text-align: right; margin-top: 10px">
          <button
            onclick="clearHistory()"
            style="
              background: none;
              border: none;
              color: var(--secondary);
              font-size: 0.8rem;
              cursor: pointer;
              text-decoration: underline;
            "
          >
            Clear History
          </button>
        </div>
      </div>
    </div>

    <script>
      // FIX: SAFE CURRENCY FORMATTER
      const formatINR = (n) => {
        if (n === null || n === undefined || isNaN(n)) return "0.00";
        return n.toLocaleString("en-IN", {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        });
      };

      // Initialize
      document.getElementById("startDate").valueAsDate = new Date();
      let charts = {}; // Store chart instances

      // --- THEME ---
      function toggleTheme() {
        document.body.classList.toggle("dark");
        const icon = document.getElementById("theme-icon");

        // ANIMATION LOGIC RESTORED
        icon.classList.add("rotate-icon");
        setTimeout(() => icon.classList.remove("rotate-icon"), 500);

        const isDark = document.body.classList.contains("dark");
        icon.innerText = isDark ? "ðŸŒž" : "ðŸŒ™";
        localStorage.theme = isDark ? "dark" : "light";
        if (charts.growth) updateChartsTheme();
      }
      if (localStorage.theme === "dark") toggleTheme();

      // --- SLIDER LOGIC ---
      const pInput = document.getElementById("principal");
      const pRange = document.getElementById("principalRange");
      const rInput = document.getElementById("rate");
      const rRange = document.getElementById("rateRange");

      pRange.addEventListener("input", (e) => {
        pInput.value = parseInt(e.target.value).toLocaleString("en-IN");
        validateForm();
      });
      rRange.addEventListener("input", (e) => {
        rInput.value = e.target.value;
        validateForm();
      });
      // Sync inputs back to sliders
      pInput.addEventListener("input", (e) => {
        let val = parseFloat(e.target.value.replace(/,/g, ""));
        if (!isNaN(val)) pRange.value = val;
        validateForm();
      });
      rInput.addEventListener("input", (e) => {
        rRange.value = e.target.value;
        validateForm();
      });

      // --- INPUT FORMATTING ---
      function formatInput(el) {
        let val = parseFloat(el.value.replace(/,/g, ""));
        if (!isNaN(val)) el.value = val.toLocaleString("en-IN");
      }
      function unformatInput(el) {
        el.value = el.value.replace(/,/g, "");
      }

      // --- COMPOUND FREQUENCY TOGGLE ---
      function toggleCompoundFreq() {
        const logic = document.getElementById("logicType").value;
        document.getElementById("freqContainer").style.display =
          logic === "compound" ? "block" : "none";
      }

      // --- VALIDATION ---
      function validateForm() {
        const pStr = document
          .getElementById("principal")
          .value.replace(/,/g, "");
        const p = parseFloat(pStr);
        const r = document.getElementById("rate").value;
        const s = document.getElementById("startDate").value;
        const e = document.getElementById("endDate").value;
        const m = document.getElementById("monthsInput").value;

        const hasTime = m || (s && e);
        const isValid = p > 0 && r >= 0 && hasTime;
        document.getElementById("calcBtn").disabled = !isValid;
      }

      ["monthsInput", "startDate", "endDate"].forEach((id) => {
        document.getElementById(id).addEventListener("input", validateForm);
      });

      // --- DATE & MONTHS ---
      function setYears(y, btn) {
        document
          .querySelectorAll("#yearPresets button")
          .forEach((b) => b.classList.remove("active"));
        if (btn) btn.classList.add("active");
        const s = new Date();
        const e = new Date();
        e.setFullYear(s.getFullYear() + y);
        document.getElementById("startDate").value = s
          .toISOString()
          .split("T")[0];
        document.getElementById("endDate").value = e
          .toISOString()
          .split("T")[0];
        document.getElementById("monthsInput").value = y * 12;
        validateForm();
      }

      function getMonths() {
        const m = parseFloat(document.getElementById("monthsInput").value);
        if (m > 0) return m;
        const s = new Date(document.getElementById("startDate").value);
        const e = new Date(document.getElementById("endDate").value);
        return (e - s) / (1000 * 60 * 60 * 24) / 30.4375; // More precise
      }

      // --- CALCULATION CORE ---
      function monthlyInterest(p) {
        const r = parseFloat(document.getElementById("rate").value);
        const type = document.getElementById("interestType").value;
        if (type === "flat") return r;
        if (type === "percent") return (p * r) / 100;
        return (p / 100) * r;
      }

      function calculate() {
        const pRaw = document
          .getElementById("principal")
          .value.replace(/,/g, "");
        let p = parseFloat(pRaw);
        let initialP = p;
        let months = getMonths();
        const logic = document.getElementById("logicType").value;
        const freq = parseInt(document.getElementById("compoundFreq").value); // Months per compound

        if (p <= 0 || months <= 0) return alert("Invalid Input");

        let full = Math.floor(months),
          frac = months - full;
        let totalInt = 0,
          accruedInt = 0;
        let mRows = "",
          yRows = "",
          labels = ["Start"],
          chartData = [p];
        let yearStart = p;

        // Loop Vars
        let month = 1;

        for (let i = 1; i <= full; i++) {
          let mi = monthlyInterest(p);
          accruedInt += mi;
          totalInt += mi;

          mRows += `<tr><td>${i}</td><td>${formatINR(p)}</td><td>${formatINR(
            mi
          )}</td><td>${formatINR(totalInt)}</td></tr>`;

          // Compounding Logic
          if (logic === "compound" && i % freq === 0) {
            p += accruedInt;
            accruedInt = 0; // Reset after adding to principal
          }

          // Chart Data (Yearly points)
          if (i % 12 === 0) {
            let currentVal =
              logic === "compound" ? p + accruedInt : initialP + totalInt;
            let yearNum = i / 12;
            labels.push("Y" + yearNum);
            chartData.push(currentVal);
            yRows += `<tr><td>${yearNum}</td><td>${formatINR(
              yearStart
            )}</td><td>${formatINR(currentVal - yearStart)}</td><td>${formatINR(
              currentVal
            )}</td></tr>`;
            yearStart = currentVal;
          }
        }

        // Partial Month
        if (frac > 0) {
          let mi = monthlyInterest(p) * frac;
          totalInt += mi;
          accruedInt += mi;
          mRows += `<tr><td>${(full + frac).toFixed(1)}*</td><td>${formatINR(
            p
          )}</td><td>${formatINR(mi)}</td><td>${formatINR(totalInt)}</td></tr>`;
        }

        // Final Totals
        let finalAmount =
          logic === "compound" ? p + accruedInt : initialP + totalInt;

        // Save to History
        saveHistory(initialP, totalInt, finalAmount, months);

        window.shareData = {
          p: finalAmount,
          totalInt,
          months,
          principal: initialP,
        };

        document.getElementById("output").innerHTML = `
        <div class="card summary-grid">
            <div class="result-box"><span>Principal</span><div class="value">â‚¹${formatINR(
              initialP
            )}</div></div>
            <div class="result-box"><span>Interest</span><div class="value">â‚¹${formatINR(
              totalInt
            )}</div></div>
            <div class="result-box highlight"><span>Total Value</span><div class="value">â‚¹${formatINR(
              finalAmount
            )}</div></div>
        </div>
        
        <div class="card chart-grid">
            <div><canvas id="growthChart"></canvas></div>
            <div style="max-height:250px; display:flex; justify-content:center;"><canvas id="pieChart"></canvas></div>
        </div>

        <div class="grid grid-2" style="margin-bottom:20px">
            <button class="calculate-btn" style="margin-top:0; background:var(--secondary)" onclick="copyText()">ðŸ“‹ Copy</button>
            <button class="calculate-btn" style="margin-top:0; background:var(--secondary)" onclick="downloadImage()">ðŸ“¸ Save</button>
        </div>

        <div class="card">
            <div class="section-header"><span class="section-title">ðŸ“† Yearly Breakdown</span></div>
            <div class="table-container"><table><tr><th>Year</th><th>Open</th><th>Growth</th><th>Close</th></tr>${yRows}</table></div>
        </div>
        <div class="card">
            <div class="section-header"><span class="section-title">ðŸ“… Monthly History</span></div>
            <div class="table-container"><table><tr><th>Mo</th><th>Base</th><th>Int.</th><th>Total Int.</th></tr>${mRows}</table></div>
        </div>
        `;

        drawCharts(labels, chartData, initialP, totalInt);
        document
          .getElementById("output")
          .scrollIntoView({ behavior: "smooth" });
        loadHistory(); // Refresh history UI
      }

      // --- CHARTING ---
      function drawCharts(labels, data, p, int) {
        // Destroy old instances
        if (charts.growth) charts.growth.destroy();
        if (charts.pie) charts.pie.destroy();

        // Line Chart
        charts.growth = new Chart(document.getElementById("growthChart"), {
          type: "line",
          data: {
            labels,
            datasets: [
              {
                label: "Growth",
                data: data,
                borderColor: "#4f46e5",
                backgroundColor: "rgba(79, 70, 229, 0.1)",
                fill: true,
                tension: 0.4,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: { legend: { display: false } },
          },
        });

        // Pie Chart
        charts.pie = new Chart(document.getElementById("pieChart"), {
          type: "doughnut",
          data: {
            labels: ["Principal", "Interest"],
            datasets: [
              {
                data: [p, int],
                backgroundColor: ["#cbd5e1", "#4f46e5"],
              },
            ],
          },
          options: { responsive: true, maintainAspectRatio: false },
        });
      }

      // --- HISTORY SYSTEM (SAFE) ---
      function saveHistory(p, i, t, m) {
        let history = [];
        try {
          history = JSON.parse(localStorage.getItem("calcHistory") || "[]");
        } catch (e) {
          history = [];
        }

        const entry = {
          date: new Date().toLocaleDateString(),
          p: p,
          i: i,
          total: t,
          desc: `â‚¹${formatINR(p)} for ${m.toFixed(1)} mo`,
        };
        history.unshift(entry);
        if (history.length > 5) history.pop();
        localStorage.setItem("calcHistory", JSON.stringify(history));
      }

      function loadHistory() {
        const list = document.getElementById("historyList");
        const card = document.getElementById("historyCard");
        let history = [];

        try {
          history = JSON.parse(localStorage.getItem("calcHistory") || "[]");
        } catch (e) {
          console.error("History corrupted, resetting.");
          localStorage.removeItem("calcHistory");
          return;
        }

        if (!Array.isArray(history) || history.length === 0) {
          card.style.display = "none";
          return;
        }

        card.style.display = "block";
        list.innerHTML = "";

        history.forEach((h) => {
          if (!h || h.total === undefined) return;

          let div = document.createElement("div");
          div.className = "history-item";
          div.innerHTML = `
                <div class="history-details">
                    <div>${h.date || "-"}</div>
                    <div>${h.desc || "-"}</div>
                </div>
                <div class="history-amount">â‚¹${formatINR(h.total)}</div>
              `;
          div.onclick = () => {
            if (h.p)
              document.getElementById("principal").value =
                h.p.toLocaleString("en-IN");
            window.scrollTo({ top: 0, behavior: "smooth" });
          };
          list.appendChild(div);
        });
      }

      function clearHistory() {
        localStorage.removeItem("calcHistory");
        loadHistory();
      }

      // Load on start
      loadHistory();

      // --- EXPORT TOOLS ---
      function copyText() {
        const t = window.shareData;
        navigator.clipboard.writeText(
          `Interest Summary\nPrincipal: â‚¹${formatINR(
            t.principal
          )}\nInterest: â‚¹${formatINR(t.totalInt)}\nTotal: â‚¹${formatINR(
            t.p
          )}\nDuration: ${t.months.toFixed(2)} months`
        );
        alert("Copied âœ…");
      }
      function downloadImage() {
        html2canvas(document.getElementById("outputWrapper"), {
          scale: 2,
          backgroundColor:
            localStorage.theme === "dark" ? "#0f172a" : "#f8fafc",
        }).then((c) => {
          let a = document.createElement("a");
          a.href = c.toDataURL();
          a.download = "interest-pro.png";
          a.click();
        });
      }
    </script>
  </body>
</html>
